name: Java CI with Gradle

on:
  pull_request:
    branches: [ "master" ]

permissions:
  pull-requests: write   # PR ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”
  checks: write          # dorny/test-reporterê°€ ì²´í¬ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ í•„ìš”
  security-events: write # Security íƒ­ì— ê²°ê³¼ë¥¼ ì˜¬ë¦¬ê¸° ìœ„í•´ í•„ìš”

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          # Gitleaksê°€ PRì˜ base commitì„ ì°¾ê¸° ìœ„í•´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.
          fetch-depth: 0

      # 2. JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # gradle/actions/setup-gradle ì‚¬ìš© ì‹œ ìºì‹±ì´ ë‚´ì¥ë˜ì–´ ìˆì–´ ë³„ë„ cache ìŠ¤í…ì´ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      # ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì¤‘ë³µ ì œê±° ê°€ëŠ¥
      # 3. Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 5. Build (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle Wrapper
        id: build
        continue-on-error: true
        run: ./gradlew build -x test

      # Gitleaks ì‹¤í–‰ (Secret í•˜ë“œì½”ë”© íƒì§€)
      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_EXIT_CODE: "0" # ì‹œí¬ë¦¿ì„ ì°¾ì•„ë„ ì‹¤íŒ¨í•˜ì§€ ì•Šì•„ì•¼ ë‹¤ìŒ ìŠ¤í… ì‹¤í–‰ ê°€ëŠ¥

      # Gitleaks ê²°ê³¼ë¥¼ GitHub Security íƒ­ì— ì—…ë¡œë“œ
      - name: Upload Gitleaks report to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif # gitleaks-actionì˜ ê¸°ë³¸ ì¶œë ¥ íŒŒì¼ ê²½ë¡œ

      # JSON ë¦¬í¬íŠ¸ë¥¼ ì½ê³  ì½”ë©˜íŠ¸ ë‚´ìš©ì„ ê°€ê³µ
      - name: Create Gitleaks PR Comment
        id: create_comment
        if: always()
        run: |
          # results.sarif íŒŒì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í… ì¢…ë£Œ
          if [ ! -f results.sarif ]; then
            echo "SARIF file not found. Skipping comment creation."
            echo "comment_body=âœ… Gitleaks did not produce a report. No secrets found." >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # SARIF íŒŒì¼ì—ì„œ ë°œê²¬ëœ leak ê°œìˆ˜ í™•ì¸ (jq ì¿¼ë¦¬ ë³€ê²½)
          LEAKS_COUNT=$(jq '.runs[0].results | length' results.sarif)
          
          if [ $LEAKS_COUNT -eq 0 ]; then
            BODY="âœ… Gitleaks scan passed. No secrets found."
          else
            BODY="ğŸš¨ Gitleaks scan failed! Found ${LEAKS_COUNT} potential secret(s).\n\n"
            BODY+="| File | Line | Rule |\n"
            BODY+="|------|------|------|\n"
            # jqë¥¼ ì‚¬ìš©í•´ SARIF íŒŒì¼ì—ì„œ ê° leak ì •ë³´ë¥¼ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ì¶”ê°€ (jq ì¿¼ë¦¬ ë³€ê²½)
            BODY+=$(jq -r '.runs[0].results[] | "| \(.locations[0].physicalLocation.artifactLocation.uri) | \(.locations[0].physicalLocation.region.startLine) | \(.ruleId) |"' results.sarif)
          fi
          
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Gitleaks ê²°ê³¼ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ
      - name: PR Comment Gitleaks Result
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: gitleaks-result # ì½”ë©˜íŠ¸ ìƒë‹¨ì— í‘œì‹œë  í—¤ë”
          message: ${{ steps.create_comment.outputs.comment_body }} # ì´ì „ ìŠ¤í…ì—ì„œ ìƒì„±í•œ ë©”ì‹œì§€ë¥¼ ì‚¬ìš© (path ëŒ€ì‹  message)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ë¹Œë“œ ë˜ëŠ” ë³´ì•ˆì ê²€ ì‹¤íŒ¨ ì‹œ ë°”ë¡œ ì¢…ë£Œ
      - name: Fail if Gitleaks or Build failed
        if: always()
        run: |
          echo "Gitleaks outcome: ${{ steps.gitleaks.outcome }}"
          echo "Build outcome: ${{ steps.build.outcome }}"
          if [ "${{ steps.gitleaks.outcome }}" = "failure" ] || [ "${{ steps.build.outcome }}" = "failure" ]; then
            echo "âŒ Either Gitleaks or Build failed. Stopping workflow."
            exit 1
          fi

  tests:
    runs-on: ubuntu-latest
    needs: build-and-scan
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          # Gitleaksê°€ PRì˜ base commitì„ ì°¾ê¸° ìœ„í•´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.
          fetch-depth: 0

      # 2. JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # gradle/actions/setup-gradle ì‚¬ìš© ì‹œ ìºì‹±ì´ ë‚´ì¥ë˜ì–´ ìˆì–´ ë³„ë„ cache ìŠ¤í…ì´ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      # ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì¤‘ë³µ ì œê±° ê°€ëŠ¥
      # 3. Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 6. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë‹¨ìœ„í…ŒìŠ¤íŠ¸ + í†µí•©í…ŒìŠ¤íŠ¸ + ì»¤ë²„ë¦¬ì§€)
      - name: Run Tests
        run: ./gradlew check --continue

      # 7. index.htmlë¡œ í™•ì¸í•˜ê¸° ìœ„í•œ Test Report ì—…ë¡œë“œ
      - name: Upload Test Report
        if: always() # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ í•­ìƒ ë¦¬í¬íŠ¸ë¥¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test/

      # 8. ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/test/html

      # 9. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ
      - name: Report Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Tests # ë¦¬í¬íŠ¸ ì´ë¦„
          path: "build/test-results/test/TEST-*.xml" # Gradle í…ŒìŠ¤íŠ¸ ê²°ê³¼ XML íŒŒì¼ ê²½ë¡œ
          reporter: java-junit # ë¦¬í¬íŠ¸ í˜•ì‹
          token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-error: 'false' # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì—¬ê¸°ì„œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ

      # 10. JaCoCo ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ
      - name: Add JaCoCo Report to PR
        id: jacoco
        if: always()
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸"



