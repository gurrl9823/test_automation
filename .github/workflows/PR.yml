name: Java CI with Gradle

on:
  pull_request:
    branches: [ "master" ]

permissions:
  pull-requests: write   # PR ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”
  checks: write          # dorny/test-reporterê°€ ì²´í¬ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ í•„ìš”

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          # Gitleaksê°€ PRì˜ base commitì„ ì°¾ê¸° ìœ„í•´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.
          fetch-depth: 0

      # 2. JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # gradle/actions/setup-gradle ì‚¬ìš© ì‹œ ìºì‹±ì´ ë‚´ì¥ë˜ì–´ ìˆì–´ ë³„ë„ cache ìŠ¤í…ì´ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      # ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì¤‘ë³µ ì œê±° ê°€ëŠ¥
      # gradle ìºì‹± : í”„ë¡œì íŠ¸ì— ì‚¬ìš©ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤, ë³€ê²½ë˜ì§€ ì•Šì€ ì½”ë“œë“¤ì˜ ì»´íŒŒì¼ ê²°ê³¼ë“¤
      # 3. Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 5. Build (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle Wrapper
        id: build
        continue-on-error: true
        run: ./gradlew build -x test

      # ë¹Œë“œ ì„±ê³µ ì‹œ PR ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
      - name: Comment on Build Success
        if: steps.build.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: build-status
          message: |
            âœ… **Gradle Build Succeeded!**
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ë¹Œë“œ ì‹¤íŒ¨ ì‹œ PR ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
      - name: Comment on Build Failure
        if: steps.build.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: build-status
          message: |
            ğŸš¨ **Gradle Build Failed!**
            
            ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ ë§í¬ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.
            [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Gitleaks ì‹¤í–‰ (Secret í•˜ë“œì½”ë”© íƒì§€)
      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_EXIT_CODE: "0" # ì‹œí¬ë¦¿ì„ ì°¾ì•„ë„ ì‹¤íŒ¨í•˜ì§€ ì•Šì•„ì•¼ ë‹¤ìŒ ìŠ¤í… ì‹¤í–‰ ê°€ëŠ¥

      # Gitleaks ê²°ê³¼ë¥¼ ê¸°ë¡. PR ì½”ë©˜íŠ¸, PR Checks, Files changed
      - name: Display Scan Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif # gitleaks-actionì˜ ê¸°ë³¸ ì¶œë ¥ íŒŒì¼ ê²½ë¡œ

      # JSON ë¦¬í¬íŠ¸ë¥¼ ì½ê³  ì½”ë©˜íŠ¸ ë‚´ìš©ì„ ê°€ê³µ
      - name: Create Gitleaks PR Comment
        id: create_comment
        if: always()
        run: |
          # results.sarif íŒŒì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í… ì¢…ë£Œ
          if [ ! -f results.sarif ]; then
            echo "SARIF file not found. Skipping comment creation."
            echo "comment_body=âœ… Gitleaks did not produce a report. No secrets found." >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # SARIF íŒŒì¼ì—ì„œ ë°œê²¬ëœ leak ê°œìˆ˜ í™•ì¸ (jq ì¿¼ë¦¬ ë³€ê²½)
          LEAKS_COUNT=$(jq '.runs[0].results | length' results.sarif)
          
          if [ $LEAKS_COUNT -eq 0 ]; then
            BODY="âœ… Gitleaks scan passed. No secrets found."
          else
            BODY="ğŸš¨ Gitleaks scan failed! Found ${LEAKS_COUNT} potential secret(s).\n\n"
            BODY+="| File | Line | Rule |\n"
            BODY+="|------|------|------|\n"
            # jqë¥¼ ì‚¬ìš©í•´ SARIF íŒŒì¼ì—ì„œ ê° leak ì •ë³´ë¥¼ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ì¶”ê°€ (jq ì¿¼ë¦¬ ë³€ê²½)
            BODY+=$(jq -r '.runs[0].results[] | "| \(.locations[0].physicalLocation.artifactLocation.uri) | \(.locations[0].physicalLocation.region.startLine) | \(.ruleId) |"' results.sarif)
          fi
          
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Gitleaks ê²°ê³¼ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ
      - name: PR Comment Gitleaks Result
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: gitleaks-result # ì½”ë©˜íŠ¸ ìƒë‹¨ì— í‘œì‹œë  í—¤ë”
          message: ${{ steps.create_comment.outputs.comment_body }} # ì´ì „ ìŠ¤í…ì—ì„œ ìƒì„±í•œ ë©”ì‹œì§€ë¥¼ ì‚¬ìš© (path ëŒ€ì‹  message)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ë¹Œë“œ ë˜ëŠ” ë³´ì•ˆì ê²€ ì‹¤íŒ¨ ì‹œ ë°”ë¡œ ì¢…ë£Œ
      - name: Fail if Gitleaks or Build failed
        if: always()
        run: |
          echo "Gitleaks outcome: ${{ steps.gitleaks.outcome }}"
          echo "Build outcome: ${{ steps.build.outcome }}"
          if [ "${{ steps.gitleaks.outcome }}" = "failure" ] || [ "${{ steps.build.outcome }}" = "failure" ]; then
            echo "âŒ Either Gitleaks or Build failed. Stopping workflow."
            exit 1
          fi

  tests:
    runs-on: ubuntu-latest
    needs: build-and-scan
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          # Gitleaksê°€ PRì˜ base commitì„ ì°¾ê¸° ìœ„í•´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.
          fetch-depth: 0

      # 2. JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # gradle/actions/setup-gradle ì‚¬ìš© ì‹œ ìºì‹±ì´ ë‚´ì¥ë˜ì–´ ìˆì–´ ë³„ë„ cache ìŠ¤í…ì´ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      # ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì¤‘ë³µ ì œê±° ê°€ëŠ¥
      # 3. Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 6. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë‹¨ìœ„í…ŒìŠ¤íŠ¸ + í†µí•©í…ŒìŠ¤íŠ¸ + ì»¤ë²„ë¦¬ì§€)
      - name: Run Tests
        run: ./gradlew check --continue

      # 7. index.htmlë¡œ í™•ì¸í•˜ê¸° ìœ„í•œ Test Report ì—…ë¡œë“œ
      - name: Upload Test Report
        if: always() # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ í•­ìƒ ë¦¬í¬íŠ¸ë¥¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test/

      # 8. ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/test/html

      # 9. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ë¥¼ workflow íƒ­ì— ì¶”ê°€
      - name: Report Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Test Report # ë¦¬í¬íŠ¸ ì´ë¦„
          path: "build/test-results/test/TEST-*.xml" # Gradle í…ŒìŠ¤íŠ¸ ê²°ê³¼ XML íŒŒì¼ ê²½ë¡œ
          reporter: java-junit # ë¦¬í¬íŠ¸ í˜•ì‹
          token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-error: 'false' # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì—¬ê¸°ì„œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ

#      # 10. JaCoCo ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ
#      - name: Add JaCoCo Report to PR
#        id: jacoco
#        if: always()
#        uses: madrapps/jacoco-report@v1.6.1
#        with:
#          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
#          token: ${{ secrets.GITHUB_TOKEN }}
#          title: "í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸"

      # JaCoCo XML ë¦¬í¬íŠ¸ë¥¼ ì§ì ‘ íŒŒì‹±í•˜ì—¬ ì»¤ë²„ë¦¬ì§€ ê³„ì‚°
      - name: Parse JaCoCo Coverage Report
        id: jacoco
        if: always() # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        run: |
          # xmllint ë„êµ¬ë¥¼ ì‚¬ìš©í•´ XML íŒŒì¼ì—ì„œ ì»¤ë²„ë¦¬ì§€ ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
          METHOD_COVERED=$(xmllint --xpath 'string(//report/counter[@type="METHOD"]/@covered)' build/reports/jacoco/test/jacocoTestReport.xml)
          METHOD_MISSED=$(xmllint --xpath 'string(//report/counter[@type="METHOD"]/@missed)' build/reports/jacoco/test/jacocoTestReport.xml)
          BRANCH_COVERED=$(xmllint --xpath 'string(//report/counter[@type="BRANCH"]/@covered)' build/reports/jacoco/test/jacocoTestReport.xml)
          BRANCH_MISSED=$(xmllint --xpath 'string(//report/counter[@type="BRANCH"]/@missed)' build/reports/jacoco/test/jacocoTestReport.xml)

          # bc ë„êµ¬ë¥¼ ì‚¬ìš©í•´ ì†Œìˆ˜ì  ê³„ì‚°ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          METHOD_TOTAL=$(echo "$METHOD_COVERED + $METHOD_MISSED" | bc)
          if [ $METHOD_TOTAL -eq 0 ]; then
            METHOD_PERCENT=100
          else
            METHOD_PERCENT=$(echo "scale=2; $METHOD_COVERED * 100 / $METHOD_TOTAL" | bc)
          fi

          BRANCH_TOTAL=$(echo "$BRANCH_COVERED + $BRANCH_MISSED" | bc)
          if [ $BRANCH_TOTAL -eq 0 ]; then
            BRANCH_PERCENT=100
          else
            BRANCH_PERCENT=$(echo "scale=2; $BRANCH_COVERED * 100 / $BRANCH_TOTAL" | bc)
          fi

          # ì½”ë©˜íŠ¸ ë©”ì‹œì§€ ë³¸ë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
          BODY="### ğŸ§ª JaCoCo í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€\n\n"
          BODY+="| ì¸¡ì • í•­ëª© | ì»¤ë²„ë¦¬ì§€ |\n"
          BODY+="|:---|:---|\n"
          BODY+="| **ë©”ì†Œë“œ (Methods)** | **${METHOD_PERCENT}%** |\n"
          BODY+="| **ë¸Œëœì¹˜ (Branches)** | **${BRANCH_PERCENT}%** |\n\n"

          # build.gradleì˜ ë£°(ìµœì†Œ 60%)ê³¼ ë¹„êµí•˜ì—¬ ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
          # awkë¥¼ ì‚¬ìš©í•´ ì†Œìˆ˜ì  ë¹„êµë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          BRANCH_VIOLATION=$(echo "$BRANCH_PERCENT 60.0" | awk '{if ($1 < $2) print "true"; else print "false"}')

          if [ "$BRANCH_VIOLATION" = "true" ]; then
            BODY+="ğŸš¨ **ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€ ë¯¸ë‹¬!**\n"
            BODY+="> ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€ê°€ **${BRANCH_PERCENT}%** ë¡œ, ëª©í‘œì¹˜ì¸ **60%** ì— ë„ë‹¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          else
            BODY+="âœ… **ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤!**"
          fi

          # ìƒì„±ëœ ë©”ì‹œì§€ë¥¼ ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "${BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ìœ„ì—ì„œ ìƒì„±í•œ ì»¤ìŠ¤í…€ ë©”ì‹œì§€ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ
      - name: Add Custom JaCoCo Report to PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          # ë‹¤ë¥¸ ì½”ë©˜íŠ¸ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ê³ ìœ í•œ í—¤ë”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          header: jacoco-coverage-report
          message: ${{ steps.jacoco.outputs.comment_body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



